import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { HierarchyNode } from '../../../interfaces/hierarchy.interface';
import { hierarchyMockData } from '../../../mockData/hierarchy.mock';

interface HierarchyState {
  tree: HierarchyNode[];
}

const initialState: HierarchyState = {
  tree: hierarchyMockData
};

const hierarchySlice = createSlice({
  name: 'hierarchy',
  initialState,
  reducers: {
    updateWeightage(
      state,
      action: PayloadAction<{ id: string; value: number }>
    ) {
      const updateNode = (nodes: HierarchyNode[]) => {
        for (const node of nodes) {
          if (node.id === action.payload.id) {
            node.weightage = action.payload.value;
            return true;
          }
          if (node.children && updateNode(node.children)) return true;
        }
        return false;
      };

      updateNode(state.tree);
    },

    deleteNode(state, action: PayloadAction<string>) {
      const removeNode = (nodes: HierarchyNode[]): HierarchyNode[] =>
        nodes
          .filter(n => n.id !== action.payload)
          .map(n => ({
            ...n,
            children: n.children ? removeNode(n.children) : []
          }));

      state.tree = removeNode(state.tree);
    }
  }
});

export const { updateWeightage, deleteNode } = hierarchySlice.actions;
export default hierarchySlice.reducer;
